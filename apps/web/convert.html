<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>T-SQL → Snowflake Converter</title>
  <style>
    /* ====== THEME (light defaults in :root, dark overrides below) ====== */
    :root{
      --bg:#f7f9ff; --panel:#ffffff; --panel-2:#f2f6ff; --text:#0b1220; --muted:#5b6b8c;
      --accent:#2952ff; --accent-2:#1e3ae6; --border:#d9e2f7; --chip:#eef3ff;
      --ok:#19b27b; --danger:#e24a4a;

      /* Code pane colors — LIGHT MODE */
      --code-bg:#f8fbff;  /* light code background */
      --code:#0b1220;     /* dark code text */

      --pane-h:72vh;      /* both left/right panes share same height */
      --radius:14px; --radius-sm:10px;
      --space:14px;
    }
    html[data-theme="dark"]{
      --bg:#0b1220; --panel:#111a30; --panel-2:#0c142b; --text:#e9eeff; --muted:#9fb0d9;
      --accent:#2952ff; --accent-2:#1e3ae6; --border:#1b2a4f; --chip:#0f1e42;

      /* Code pane colors — DARK MODE */
      --code-bg:#0a1226;
      --code:#e6eaff;
    }

    /* ====== BASE ====== */
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    .wrap{max-width:1400px;margin:28px auto;padding:0 var(--space)}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 28px rgba(0,0,0,.08)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .ttl{display:flex;gap:10px;align-items:center;font-weight:800}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{all:unset;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;background:var(--accent);color:#fff;transition:.12s ease}
    button:hover{background:var(--accent-2)} button:active{transform:scale(.98)}
    .ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .danger{background:var(--danger)}
    .subhd{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--muted);background:rgba(255,255,255,.45)}
    html[data-theme="dark"] .subhd{background:rgba(255,255,255,.04)}

    .pills{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px;border-top:1px dashed var(--border);background:rgba(41,82,255,.06)}
    .pill{font-size:12px;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted)}

    /* ====== GRID ====== */
    .grid{padding:var(--space);display:grid;gap:var(--space);grid-template-columns:1fr 1fr}
    .col{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-width:0}
    .colhd{
      /* 3 regions: label | (tabs) | actions — keeps alignment perfect */
      display:grid;grid-template-columns:auto 1fr auto;gap:10px;
      align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.35)
    }
    html[data-theme="dark"] .colhd{background:rgba(255,255,255,.04)}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--muted)}

    /* Tabs */
    .tabs{justify-self:center;display:inline-flex;gap:8px;border:1px solid var(--border);border-radius:999px;padding:2px;background:var(--panel)}
    .tab{padding:6px 12px;border-radius:999px;font-weight:700;color:var(--text);cursor:pointer}
    .tab.active{background:var(--accent);color:#fff}

    /* Panes */
    textarea{
      width:100%;height:var(--pane-h);border:0;resize:none;outline:none;background:var(--panel);color:var(--text);
      font:500 16px/1.55 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;padding:12px
    }
    .code{
      height:var(--pane-h);overflow:auto;background:var(--code-bg);color:var(--code);
      font:500 16px/1.55 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;padding:12px;white-space:pre;tab-size:2;
      border-top:1px solid var(--border)
    }
    .hidden{display:none}

    /* Syntax highlight colors */
    .kw{color:#7aa2ff} .fn{color:#ffd479} .id{color:#9af0c7} .str{color:#ffc58f} .num{color:#b4f1ff}
    .line.plus{background:rgba(25,178,123,.16)} .line.minus{background:rgba(226,74,74,.18)}
    .ln{opacity:.6;margin-right:10px}

    @media (max-width:1100px){
      .grid{grid-template-columns:1fr}
      :root{--pane-h:60vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- Header -->
      <div class="hd">
        <div class="ttl"><span class="dot"></span><span>T-SQL → Snowflake Converter</span></div>
        <div class="toolbar">
          <button class="ghost" id="themeBtn">Toggle Theme</button>
          <button class="ghost" id="fullscreenBtn">Full Screen</button>
          <button class="ghost" id="homeBtn">Home</button>
          <button class="danger" id="resetBtn">Reset</button>
        </div>
      </div>

      <!-- Heads-up -->
      <div class="subhd">
        <strong>Heads up:</strong> Rule-based converter. Ambiguous T-SQL is left <em>unchanged</em>. Review output before production.
      </div>

      <!-- Supported mappings -->
      <div class="pills">
        <span class="pill">TOP → LIMIT</span><span class="pill">ISNULL → COALESCE</span>
        <span class="pill">GETDATE() → CURRENT_TIMESTAMP()</span><span class="pill">LEN → LENGTH</span>
        <span class="pill">LEFT(x,n) → SUBSTR(x,1,n)</span><span class="pill">CHARINDEX → POSITION</span>
        <span class="pill">CONVERT/TRY_CONVERT → CAST/TRY_CAST</span><span class="pill">DATEADD/DATEDIFF parts normalized</span>
        <span class="pill">[ident] → "ident"</span>
      </div>

      <!-- Panels -->
      <div class="grid">
        <!-- INPUT -->
        <section class="col">
          <div class="colhd">
            <span class="tag">T-SQL</span>
            <div></div> <!-- keeps header grid aligned with right column -->
            <div style="justify-self:end;display:flex;gap:8px">
              <button class="ghost" id="convertBtn">Convert (Ctrl/Cmd+Enter)</button>
            </div>
          </div>
          <textarea id="tsql" spellcheck="false" placeholder="Paste T-SQL here…"></textarea>
        </section>

        <!-- OUTPUT -->
        <section class="col">
          <div class="colhd">
            <span class="tag">Output</span>

            <!-- centered tabs -->
            <div class="tabs" id="tabs">
              <button class="tab active" id="tabConverted">Converted</button>
              <button class="tab" id="tabDiff">Diff</button>
            </div>

            <!-- right actions -->
            <div style="justify-self:end;display:flex;gap:8px">
              <button class="ghost" id="copyBtn">Copy</button>
              <button class="ghost" id="downloadBtn">Download .sql</button>
            </div>
          </div>

          <pre id="converted" class="code"></pre>
          <pre id="diffview"  class="code hidden"></pre>
        </section>
      </div>
    </div>
  </div>

  <script>
    /* ====== THEME (default dark) ====== */
    (function(){
      const KEY='theme', root=document.documentElement;
      const stored = localStorage.getItem(KEY) || 'dark';  // default to dark
      root.setAttribute('data-theme', stored);
      document.getElementById('themeBtn').onclick=()=>{
        const cur=root.getAttribute('data-theme')||'dark';
        const next=cur==='light'?'dark':'light';
        root.setAttribute('data-theme', next); localStorage.setItem(KEY,next);
      };
    })();

    /* ====== ELEMENTS ====== */
    const $ = id => document.getElementById(id);
    const tsql = $('tsql'), converted = $('converted'), diffview = $('diffview');

    /* ====== LIGHTWEIGHT SQL HIGHLIGHT ====== */
    const KW = /\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|LEFT JOIN|INNER JOIN|RIGHT JOIN|FULL JOIN|JOIN|ON|AS|AND|OR|NOT|IN|IS NULL|IS NOT NULL|BETWEEN|DISTINCT|TOP|LIMIT|HAVING|UNION ALL|UNION|CASE|WHEN|THEN|ELSE|END|QUALIFY)\b/gi;
    const FN = /\b(COALESCE|DATEADD|DATEDIFF|CURRENT_TIMESTAMP|SUBSTR|POSITION|LENGTH|RIGHT|CAST|TRY_CAST)\b/gi;
    const ID = /"[^"]+"|\[[^\]]+\]/g;
    const STR = /'[^']*'/g;
    const NUM = /\b\d+(\.\d+)?\b/g;

    function highlight(sql){
      return (sql||'')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(STR, m=>`<span class="str">${m}</span>`)
        .replace(ID,  m=>`<span class="id">${m}</span>`)
        .replace(FN,  m=>`<span class="fn">${m}</span>`)
        .replace(KW,  m=>`<span class="kw">${m}</span>`)
        .replace(NUM, m=>`<span class="num">${m}</span>`);
    }

    /* ====== SIMPLE LINE DIFF ====== */
    function lineDiff(a,b){
      const A=a.split(/\r?\n/), B=b.split(/\r?\n/);
      const max=Math.max(A.length,B.length);
      const out=[];
      for(let i=0;i<max;i++){
        const lA=A[i]??"", lB=B[i]??"";
        if(lA===lB) out.push(`<div class="line"><span class="ln">${i+1}</span>${highlight(lB)}</div>`);
        else{
          if(lA) out.push(`<div class="line minus"><span class="ln">-</span>${highlight(lA)}</div>`);
          if(lB) out.push(`<div class="line plus"><span class="ln">+</span>${highlight(lB)}</div>`);
        }
      }
      return out.join("\n");
    }

    /* ====== ACTIONS ====== */
    async function convert(){
      const raw = tsql.value||'';
      if(!raw.trim()){ converted.innerHTML='(no output)'; diffview.innerHTML=''; return; }
      converted.textContent='Converting…';
      try{
        let r = await fetch('/convert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tsql: raw }) });
        if(!r.ok) r = await fetch('/convert/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tsql: raw }) });
        const j = await r.json();
        const out = (j.snowflake_sql || j.sql || j.output || '').trim();
        converted.innerHTML = highlight(out);
        diffview.innerHTML  = lineDiff(raw, out);
      }catch(e){
        console.error(e); converted.textContent='Error contacting server.'; diffview.textContent='';
      }
    }

    function copyOut(){
      const text = converted.textContent || '';
      navigator.clipboard.writeText(text).then(()=>{
        const btn=$('copyBtn'), old=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,900);
      });
    }
    function downloadOut(){
      const blob = new Blob([converted.textContent||''], {type:'text/sql'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='snowflake.sql'; a.click(); URL.revokeObjectURL(a.href);
    }
    function toggleFullscreen(){
      const el=document.querySelector('.card');
      if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
    }

    /* ====== WIRING ====== */
    $('convertBtn').onclick = convert;
    $('copyBtn').onclick   = copyOut;
    $('downloadBtn').onclick = downloadOut;
    $('fullscreenBtn').onclick = toggleFullscreen;
    $('resetBtn').onclick = ()=>{ tsql.value=''; converted.innerHTML=''; diffview.innerHTML=''; tsql.focus(); };
    $('homeBtn').onclick  = ()=>{ location.href='/'; };

    // Tabs
    const tabConverted=$('tabConverted'), tabDiff=$('tabDiff');
    tabConverted.onclick=()=>{ tabConverted.classList.add('active'); tabDiff.classList.remove('active'); converted.classList.remove('hidden'); diffview.classList.add('hidden'); };
    tabDiff.onclick=()=>{ tabDiff.classList.add('active'); tabConverted.classList.remove('active'); converted.classList.add('hidden'); diffview.classList.remove('hidden'); };

    // Keyboard shortcut
    tsql.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); convert(); }
    });

    // Starter sample (good for demos)
    tsql.value = `-- Example: users recent
SELECT TOP (3) [Id], ISNULL([Name], 'N/A') AS [Name]
FROM [dbo].[Users]
WHERE [Active] = 1
ORDER BY [createdAt] DESC;`;
    convert();
  </script>
</body>
</html>
