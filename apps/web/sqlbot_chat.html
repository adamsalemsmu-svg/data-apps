<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SQLBot Chat</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel-2:#101a33;
      --text:#e5edff;
      --muted:#9fb0d9;
      --accent:#2952ff;
      --accent-2:#1e3ae6;
      --ok:#0ea66a;
      --danger:#e24a4a;
      --chip:#10224b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap{
      max-width:1100px;
      margin:40px auto;
      padding:0 16px;
    }
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid #172143;
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid #182246;
      background:rgba(255,255,255,0.02);
    }
    .ttl{display:flex;gap:10px;align-items:center;font-weight:700}
    .ttl .dot{width:9px;height:9px;border-radius:50%;background:#7aa2ff;box-shadow:0 0 10px #7aa2ff}
    .btns{display:flex;gap:8px}
    button{
      all:unset;
      padding:8px 12px;
      background:var(--accent);
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      color:white;
      transition:transform .06s ease, background .12s ease, opacity .12s ease;
      user-select:none;
    }
    button:hover{background:var(--accent-2)}
    button:active{transform:scale(.98)}
    .btn-ghost{background:#192859;color:#dbe6ff;border:1px solid #22336b}
    .btn-ghost:hover{background:#1b2f6e}
    .btn-danger{background:var(--danger)}
    .pad{padding:12px 14px}
    #messages{
      height:58vh;
      overflow:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      scroll-behavior:smooth;
      background:radial-gradient(800px 300px at 50% -20%, rgba(41,82,255,.15), transparent 60%);
    }
    .msg{
      max-width:70%;
      padding:10px 12px;
      border:1px solid #1a264e;
      border-radius:12px;
      word-wrap:break-word;
      white-space:pre-wrap;
      line-height:1.35;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
    }
    .user{align-self:flex-end;background:#092045;border-color:#13337e}
    .bot{align-self:flex-start;background:#0d2519;border-color:#144d36}
    .chip{
      display:inline-block;
      padding:2px 8px;
      margin-right:6px;
      border-radius:999px;
      background:var(--chip);
      color:#b7cbff;
      border:1px solid #1c2f6b;
      font-size:12px;
      vertical-align:middle;
    }
    #typing{height:18px;color:var(--muted);font-style:italic;padding:0 16px 6px}
    .input-bar{
      display:flex;gap:10px;align-items:center;padding:12px 14px;border-top:1px solid #182246;background:#0c152d;position:sticky;bottom:0
    }
    .field{
      display:flex;gap:8px;align-items:center;background:#0b1a36;border:1px solid #1a2a55;border-radius:10px;padding:8px 10px;flex:1
    }
    .field input{
      all:unset;color:var(--text);width:100%;
    }
    .me{
      width:130px
    }
    .send{
      background:var(--accent);
      padding:10px 16px;
      border-radius:10px
    }
    .send:hover{background:var(--accent-2)}
    .kbd{opacity:.55}
    @media(max-width:680px){
      #messages{height:62vh}
      .msg{max-width:86%}
      .me{width:100px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-hd">
        <div class="ttl"><span class="dot"></span><span>SQLBot Chat</span></div>
        <div class="btns">
          <button class="btn-ghost" id="homeBtn">Home</button>
          <button class="btn-ghost btn-danger" id="clearBtn">Clear</button>
        </div>
      </div>

      <div id="messages" class="pad"></div>
      <div id="typing"></div>

      <div class="input-bar">
        <div class="field me">
          <span class="kbd">ðŸ‘¤</span>
          <input id="user" value="adam" aria-label="Your name"/>
        </div>
        <div class="field">
          <span class="kbd">ðŸ’¬</span>
          <input id="text" placeholder="Ask about SQL, Snowflake, or dataâ€¦" aria-label="Message"/>
        </div>
        <button id="sendBtn" class="send">Send</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const messages = $("#messages");
    const typing = $("#typing");
    const userInp = $("#user");
    const textInp = $("#text");
    const sendBtn = $("#sendBtn");
    const clearBtn = $("#clearBtn");
    const homeBtn = $("#homeBtn");

    const STORE = "chatHistoryV2";

    function addMsg(sender, text){
      const b = document.createElement("div");
      b.className = "msg " + (sender==="user"?"user":"bot");
      const who = sender==="user" ? userInp.value : `SQLBot`;
      b.innerHTML = `<span class="chip">${who}</span>${escapeHtml(text)}`;
      messages.appendChild(b);
      messages.scrollTop = messages.scrollHeight;
      save(sender, text);
    }

    function escapeHtml(s){
      return (s??"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function save(sender, text){
      try{
        const arr = JSON.parse(localStorage.getItem(STORE)||"[]");
        arr.push({sender,text,ts:Date.now()});
        localStorage.setItem(STORE, JSON.stringify(arr));
      }catch(e){}
    }

    function load(){
      try{
        const arr = JSON.parse(localStorage.getItem(STORE)||"[]");
        messages.innerHTML="";
        for(const m of arr){
          const b = document.createElement("div");
          b.className = "msg " + (m.sender==="user"?"user":"bot");
          const who = m.sender==="user"? userInp.value : "SQLBot";
          b.innerHTML = `<span class="chip">${who}</span>${escapeHtml(m.text)}`;
          messages.appendChild(b);
        }
        messages.scrollTop = messages.scrollHeight;
      }catch(e){}
    }

    function setTyping(show, txt="SQLBot is typingâ€¦"){
      typing.textContent = show ? txt : "";
    }

    async function postJSON(url, body){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body),
      });
      if(!res.ok) throw new Error(res.status+" "+res.statusText);
      return res.json();
    }

    async function send(){
      const user = userInp.value.trim();
      const msg  = textInp.value.trim();
      if(!user || !msg) return;
      addMsg("user", msg);
      textInp.value = "";
      setTyping(true);

      const payload = { user, message: msg };

      try{
        // try /chat then /chat/
        let data;
        try{
          data = await postJSON("/chat", payload);
        }catch(_){
          data = await postJSON("/chat/", payload);
        }
        setTyping(false);
        addMsg("bot", data?.reply ?? "Hmm, I couldn't parse a reply.");
      }catch(err){
        setTyping(false);
        addMsg("bot", "Error reaching server. Please check the backend.");
        console.error(err);
      }
    }

    sendBtn.addEventListener("click", send);
    textInp.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });
    clearBtn.addEventListener("click", ()=>{
      localStorage.removeItem(STORE);
      messages.innerHTML="";
      typing.textContent="";
      textInp.focus();
    });
    homeBtn.addEventListener("click", ()=>{ window.location.href="/"; });

    // boot
    load();
    textInp.focus();
  </script>
</body>
</html>
