<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SQLBot Chat</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#10162b; --panel-2:#0f1530; --text:#e7eef9; --muted:#9aa7bd;
      --border:#1d2444; --btn:#1e40af; --btn-hover:#1b3a9c; --bot:#0e2a1a; --user:#0e1a3a;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg); color:var(--text); margin:0; min-height:100vh;
      display:flex; justify-content:center; align-items:flex-start;
    }
    #wrap{
      width:100%; max-width:880px; margin:40px 16px 28px;
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.12); overflow:hidden; display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; padding:12px 14px;
      border-bottom:1px solid var(--border); background:linear-gradient(180deg,var(--panel-2),transparent);
    }
    header h1{margin:0; font-size:16px}
    .btn{ padding:8px 12px; border:0; border-radius:8px; background:var(--btn); color:#fff; cursor:pointer; font-weight:700; font-size:12.5px }
    .btn:hover{ background:var(--btn-hover) }
    #messages{
      flex:1; height:520px; overflow-y:auto; padding:16px; background:#0d1225; display:flex; flex-direction:column;
    }
    .bubble{border:1px solid var(--border); border-radius:10px; padding:10px 14px; margin:8px 0; max-width:80%; white-space:pre-wrap; word-wrap:break-word;}
    .user{ align-self:flex-end; background:var(--user); color:#cfe2ff }
    .bot{  align-self:flex-start; background:var(--bot);  color:#d8ffe3 }
    #typing{ display:none; font-style:italic; color:#aab3c7; font-size:13px; padding:6px 14px }
    #inputbar{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:var(--panel-2) }
    input[type="text"]{ flex:1; padding:10px; border:1px solid var(--border); border-radius:8px; background:#0d1225; color:var(--text); outline:none; font-size:14px }
    #diag{ display:none; padding:8px 14px; color:#fee; background:#4b1a1a; border-top:1px solid #612; font-size:12.5px }
  </style>
</head>
<body>
  <div id="wrap">
    <header>
      <h1>ðŸ’¬ SQLBot Chat</h1>
      <div>
        <button id="home" class="btn" type="button">Home</button>
        <button id="clear" class="btn" type="button" title="Clear history">Clear</button>
      </div>
    </header>

    <div id="messages"></div>
    <div id="typing">SQLBot is typingâ€¦</div>
    <div id="diag"></div>

    <div id="inputbar">
      <input id="user" type="text" placeholder="Your name" value="adam"/>
      <input id="message" type="text" placeholder="Ask me about SQL, Snowflake, or dataâ€¦"/>
      <!-- inline onclick is a safety net in case binding fails -->
      <button id="send" class="btn" type="button" onclick="window.__send && window.__send()">Send</button>
    </div>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const messages = $("messages"), typing = $("typing"), diag = $("diag");
    const userEl = $("user"), msgEl = $("message"), sendBtn = $("send");
    const clearBtn = $("clear"), homeBtn = $("home");

    function showDiag(txt){
      diag.textContent = txt;
      diag.style.display = txt ? "block" : "none";
    }

    function addBubble(text, who, save=true){
      const div = document.createElement("div");
      div.className = "bubble " + who;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      if (save) {
        const hist = JSON.parse(localStorage.getItem("chatHistory") || "[]");
        hist.push({text, sender: who});
        localStorage.setItem("chatHistory", JSON.stringify(hist.slice(-200)));
      }
    }

    function loadHistory(){
      const hist = JSON.parse(localStorage.getItem("chatHistory") || "[]");
      messages.innerHTML = "";
      hist.forEach(m => addBubble(m.text, m.sender, false));
      messages.scrollTop = messages.scrollHeight;
    }

    function setTyping(on){ typing.style.display = on ? "block" : "none"; }

    async function postJSON(url, body){
      const res = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        let msg = `${res.status} ${res.statusText}`;
        try { const j = await res.json(); if (j && j.detail) msg = typeof j.detail === "string" ? j.detail : JSON.stringify(j.detail); } catch {}
        throw new Error(msg);
      }
      return res.json();
    }

    async function send(){
      showDiag("");
      const user = (userEl.value || "user").trim();
      const text = (msgEl.value || "").trim();
      if (!text) return;

      // optimistic UI
      addBubble(`${user}: ${text}`, "user");
      msgEl.value = "";
      msgEl.focus();
      setTyping(true);
      sendBtn.disabled = true;

      const payload = { user, message: text };

      try {
        // try /chat/ then fallback to /chat (covers either route shape)
        let data;
        try {
          data = await postJSON("/chat/", payload);
        } catch {
          data = await postJSON("/chat", payload);
        }
        const reply = (data && typeof data.reply === "string") ? data.reply : "(no reply)";
        addBubble(`SQLBot: ${reply}`, "bot");
      } catch (e) {
        addBubble(`SQLBot: request failed â€” ${e.message}`, "bot");
        showDiag(`Network / server error: ${e.message}`);
      } finally {
        setTyping(false);
        sendBtn.disabled = false;
      }
    }

    // expose as strong fallback (button inline onclick uses this)
    window.__send = send;

    function bind(){
      sendBtn.addEventListener("click", send);
      msgEl.addEventListener("keydown", (e)=>{ if (e.key === "Enter") send(); });
      clearBtn.addEventListener("click", ()=>{ localStorage.removeItem("chatHistory"); messages.innerHTML = ""; showDiag(""); });
      homeBtn.addEventListener("click", ()=>{ location.href = "/"; });
      loadHistory();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bind, { once:true });
    } else {
      bind();
    }
  })();
  </script>
</body>
</html>
